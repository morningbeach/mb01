// schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//
// ENUMS
//

// 大類別（前台主選單用）
enum Category {
  GIFT // 禮品
  GIFT_BOX // 包裝盒
  GIFT_SET // 禮品套組
}

// 產品狀態（後台管理用）
enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum HomeSectionType {
  HERO
  WHY
  PRODUCTS
  FACTORY
  BLOG
  CTA
  RICH_TEXT // 未來要加自訂文字區塊可以用這個
}

//
// MODELS
//

model Product {
  id   String @id @default(cuid())
  slug String @unique
  name String

  // 大方向類別（GIFT / GIFT_BOX / GIFT_SET）
  category Category

  // 前台短說明 / 內文
  shortDesc   String?
  description String?

  // ✅ 新圖片系統：直接存 URL
  // 大圖（封面）：/admin 用 ImageInputField name="coverImage"
  coverImage String?

  // 小圖（Gallery）：/admin 用 GalleryImagesInputField name="gallery"
  gallery       String[]
  productImages ProductImage[]

  // 基本商業資訊
  sku       String? @unique
  minQty    Int?
  priceHint String?
  currency  String?

  // 產品狀態
  status ProductStatus @default(ACTIVE)

  // 更細緻的規格（前台 detail page 用）
  leadTime      String? // 交期，例如 "約 25–30 天（不含運輸）"
  materials     String? // 主要材質描述
  dimensions    String? // 完成尺寸／可放 L×W×H 或 mm
  packagingInfo String? // 單品包裝 & 外箱裝量
  originCountry String? // 產地：CN / TW / etc.
  unit          String? // 計價單位：set / pc / pair…
  notesForBuyer String? // 給採購看的備註（注意事項、建議量）

  // 關聯：tags（用來做所有分類篩選）
  tags ProductTag[]

  // 關聯：這個產品是否本身是一個 GiftSet master
  giftSet GiftSet?

  // 關聯：如果這個產品被其他 GiftSet 當成子項目
  giftSetItems GiftSetItem[]

  // SEO
  seoTitle       String?
  seoDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id    String  @id @default(cuid())
  slug  String  @unique
  name  String
  color String?

  // 前台小標題（例如「中秋月餅禮盒」、「ESG 禮品方案」）
  subtitle String?

  products  ProductTag[]
  blogPosts BlogTag[]

  // /products 分類頁用：FrontCategory 底下的 group 對應到哪個 Tag
  frontCategoryGroups FrontCategoryTagGroup[]
}

model ProductTag {
  productId String
  tagId     String

  product Product @relation(fields: [productId], references: [id])
  tag     Tag     @relation(fields: [tagId], references: [id])

  @@id([productId, tagId])
}

model GiftSet {
  id        String @id @default(cuid())
  productId String @unique

  // 這個 GiftSet 本身對應到一個 Product（category = GIFT_SET）
  product Product @relation(fields: [productId], references: [id])

  // 套組裡的子項目
  items GiftSetItem[]
}

model GiftSetItem {
  id        String @id @default(cuid())
  giftSetId String
  productId String
  quantity  Int    @default(1)

  // 關聯到 GiftSet
  giftSet GiftSet @relation(fields: [giftSetId], references: [id])

  // 關聯到 Product（這個套組裡的某個商品）
  product Product @relation(fields: [productId], references: [id])

  @@index([giftSetId])
  @@index([productId])
}

model BlogPost {
  id          String    @id @default(cuid())
  slug        String    @unique
  title       String
  excerpt     String?
  content     String // 之後可以存 Markdown
  coverImage  String?
  publishedAt DateTime?
  isPublished Boolean   @default(false)

  tags      BlogTag[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model BlogTag {
  blogPostId String
  tagId      String

  blogPost BlogPost @relation(fields: [blogPostId], references: [id])
  tag      Tag      @relation(fields: [tagId], references: [id])

  @@id([blogPostId, tagId])
}

model Page {
  id    String @id @default(cuid())
  slug  String @unique
  title String

  // 之後可以換成 rich text / JSON，先用 String 保存
  content        String
  heroImage      String?
  seoTitle       String?
  seoDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdminUser {
  id       String  @id @default(cuid())
  email    String  @unique
  name     String?
  password String
  role     String  @default("admin")
}

model FrontCategory {
  id   String @id @default(cuid())
  slug String @unique // URL 用：gifts, gift-boxes, gift-sets, services...
  name String // 導覽 / 卡片標題用：例如 "Gifts"

  // 單一分項內頁 hero 區塊文案
  heroTitle    String? // 分類頁大標題
  heroSubtitle String? // 分類頁副標
  heroImage    String? // 分類頁 hero 圖片 URL（可用圖床 / 上傳）

  // /products 總覽頁上的卡片內容
  cardTitle       String? // 總覽卡片大標
  cardDescription String? // 卡片描述
  cardImage       String? // 卡片圖片 URL（可用圖床 / 上傳）

  // 可選：對應 Product.Category 作為基礎篩選
  baseCategory Category?

  order    Int     @default(0)
  isActive Boolean @default(true)

  tagGroups FrontCategoryTagGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FrontCategoryTagGroup {
  id              String        @id @default(cuid())
  frontCategoryId String
  frontCategory   FrontCategory @relation(fields: [frontCategoryId], references: [id])

  label       String // 分組的小標，例如 "Mid-Autumn programs"
  description String? // 可選，放在分組標題下面

  tagId String
  tag   Tag    @relation(fields: [tagId], references: [id])

  order Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 可能是舊版 / 簡易圖庫用，可當 legacy 用
model ImageAsset {
  id        String   @id @default(cuid())
  url       String
  label     String?
  createdAt DateTime @default(now())
}

// 首頁動態區塊設定（後台 JSON 編輯器用）
model HomeSection {
  id      Int             @id @default(autoincrement())
  type    HomeSectionType
  order   Int             @default(100) // 數字越小越前面
  enabled Boolean         @default(true)

  /// JSON 內容，依 type 不同有不同結構：
  /// HERO: { titleLine1_en, titleLine1_zh, ... }
  /// WHY / PRODUCTS / FACTORY: { title_en, title_zh, subtitle_en, subtitle_zh, cards: [...] }
  /// BLOG: { title_en, ... , posts: [...] }
  /// CTA: { title_en, title_zh, body_en, body_zh, ... }
  payload Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ✅ 圖床 / 相簿系統（對接 R2 / S3）

model Image {
  id         String  @id @default(cuid())
  url        String  @unique // 對外可直接使用的 URL
  storageKey String  @unique // R2/S3 裡的 key，例如 "uploads/2025/11/xxx.webp"
  width      Int?
  height     Int?
  size       Int? // bytes
  mimeType   String?
  alt        String?
  title      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 關聯：做為 Product 圖庫中的一張圖（如果之後要用 ProductImage 這張表）
  productImages ProductImage[]

  // 關聯：做為 Album 的封面圖
  albumsAsCover Album[] @relation("AlbumCoverImage")

  // 關聯：出現在哪些 Album（相簿）裡
  albumItems AlbumImage[]
}

/// 相簿（之後 homepage 區塊、產品系列都可以掛「相簿」）
model Album {
  id          String  @id @default(cuid())
  slug        String  @unique // 例如 "homepage-hero", "factory-gallery"
  name        String
  description String?

  coverImageId String?
  coverImage   Image?  @relation("AlbumCoverImage", fields: [coverImageId], references: [id])

  isSystem Boolean @default(false) // true = 系統內建相簿，不允許刪除

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items AlbumImage[]
}

/// 相簿內的圖片排序
model AlbumImage {
  id       String @id @default(cuid())
  albumId  String
  imageId  String
  position Int    @default(0)

  album Album @relation(fields: [albumId], references: [id])
  image Image @relation(fields: [imageId], references: [id])

  @@unique([albumId, imageId])
}

/// 產品與圖片的多對多（含排序）
/// （目前 Product 已經直接存 URL，這張表可以先保留作為未來擴充用）
model ProductImage {
  id        String @id @default(cuid())
  productId String
  imageId   String
  position  Int    @default(0)

  product Product @relation(fields: [productId], references: [id])
  image   Image   @relation(fields: [imageId], references: [id])

  @@unique([productId, imageId])
}
