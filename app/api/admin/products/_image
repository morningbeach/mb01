// app/api/admin/products/imageUtils.ts
import { prisma } from "@/lib/prisma";
import { R2_PUBLIC_BASE_URL } from "@/lib/r2";

export async function getOrCreateImageByUrl(url: string) {
  const trimmed = url.trim();
  if (!trimmed) return null;

  const existing = await prisma.image.findUnique({
    where: { url: trimmed },
  });
  if (existing) return existing;

  // 推測 storageKey：如果是 R2 自家網址，就把前綴砍掉
  let storageKey = trimmed;
  if (trimmed.startsWith(R2_PUBLIC_BASE_URL)) {
    storageKey = trimmed.replace(R2_PUBLIC_BASE_URL + "/", "");
  }

  return prisma.image.create({
    data: {
      url: trimmed,
      storageKey,
      title: trimmed.split("/").pop() ?? null,
    },
  });
}

/**
 * 把表單送來的 URL（coverImage + images[]）轉成：
 * - Product.coverImageId
 * - ProductImage 列表（gallery）
 */
export async function updateProductImagesFromForm(
  productId: string,
  coverImageUrl: string | null,
  galleryUrls: string[],
) {
  // 處理封面
  let coverImageId: string | null = null;
  if (coverImageUrl && coverImageUrl.trim()) {
    const img = await getOrCreateImageByUrl(coverImageUrl);
    coverImageId = img?.id ?? null;
  }

  // 更新 Product.coverImageId
  await prisma.product.update({
    where: { id: productId },
    data: { coverImageId },
  });

  // 處理 gallery（ProductImage）
  const uniqueUrls = Array.from(new Set(galleryUrls.filter(Boolean)));

  // 清掉舊的 gallery
  await prisma.productImage.deleteMany({
    where: { productId },
  });

  if (uniqueUrls.length === 0) return;

  const images = await Promise.all(
    uniqueUrls.map((u) => getOrCreateImageByUrl(u)),
  );
  const valid = images.filter((x): x is NonNullable<typeof x> => !!x);

  if (valid.length === 0) return;

  await prisma.productImage.createMany({
    data: valid.map((img, index) => ({
      productId,
      imageId: img.id,
      position: index,
    })),
    skipDuplicates: true,
  });
}
